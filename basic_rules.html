<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>コースデビュー「いろは」 | 3タップルールズ</title>

  <style>
    :root{
      --bg:#f5fff7; --card:#fff; --green:#00bfa5; --yellow:#FFD84D;
      --shadow:0 8px 22px rgba(0,0,0,.10);
      --shadow2:0 3px 10px rgba(0,0,0,.08);
      --radius:22px;
    }
    *{box-sizing:border-box;}
    body{font-family:Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding-bottom:88px;color:#222;}

    header{
      background:var(--green);color:#fff;text-align:center;
      padding:18px 14px 16px;font-weight:800;
      border-bottom-left-radius:34px;border-bottom-right-radius:34px;
      box-shadow:var(--shadow);
    }
    header .titleRow{display:flex;align-items:center;justify-content:center;gap:10px;font-size:26px;line-height:1.15;flex-wrap:wrap;}
    header .titleRow img{width:26px;height:26px;vertical-align:middle;}
    header .sub{display:block;margin-top:6px;font-size:14px;font-weight:700;opacity:.95;}

    .topArea{width:92%;max-width:720px;margin:14px auto 0;}
    .topBtn{
      display:block;width:100%;text-align:center;background:var(--yellow);
      color:#333;text-decoration:none;font-weight:900;padding:14px 0;border-radius:999px;box-shadow:var(--shadow2);
    }
    .searchWrap{margin-top:12px;background:#fff;border-radius:999px;box-shadow:var(--shadow2);padding:10px 14px;}
    #searchInput{width:100%;border:none;outline:none;font-size:16px;background:transparent;}

    .chipRow{width:92%;max-width:720px;margin:12px auto 0;display:flex;gap:10px;overflow-x:auto;padding-bottom:2px;-webkit-overflow-scrolling:touch;}
    .chip{flex:0 0 auto;border:none;background:#fff;color:#0d6f65;font-weight:900;padding:10px 16px;border-radius:999px;box-shadow:var(--shadow2);cursor:pointer;white-space:nowrap;}
    .chip.active{background:#c9f3ea;outline:2px solid rgba(0,191,165,.25);}

    .results{width:92%;max-width:720px;margin:12px auto 0;display:none;}
    .resultsHeader{font-weight:900;margin:4px 0 8px;color:#0d6f65;}
    .resultsGrid{display:grid;gap:10px;}
    .resultBtn{display:block;width:100%;background:#fff;text-decoration:none;color:#222;padding:14px;border-radius:16px;box-shadow:var(--shadow2);font-weight:800;line-height:1.25;}
    .resultMeta{margin-top:6px;font-size:12px;color:#0d6f65;font-weight:800;opacity:.9;}

    .categoryGrid{width:92%;max-width:720px;margin:14px auto 0;display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .accordion{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow2);overflow:hidden;border:1px solid rgba(0,0,0,.04);}
    .accHeader{width:100%;border:none;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px;}
    .accTitle{font-size:20px;font-weight:900;color:#0d6f65;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;flex:1;}
    .accArrow{font-size:18px;font-weight:900;color:#0d6f65;opacity:.85;width:22px;text-align:center;flex:0 0 auto;transition:transform .2s ease;}
    .accordion.open .accArrow{transform:rotate(180deg);}

    .accPanel{max-height:0;overflow:hidden;transition:max-height .22s ease;border-top:1px solid rgba(0,0,0,.06);background:rgba(245,255,247,.55);}
    .accordion.open .accPanel{max-height:1200px;}

    .itemList{padding:12px;display:flex;flex-direction:column;gap:10px;}
    .itemBtn{
      display:block;width:100%;background:#fff;color:#222;text-decoration:none;
      padding:14px;border-radius:16px;box-shadow:var(--shadow2);font-weight:900;line-height:1.25;
      white-space:normal;word-break:break-word;
    }

    .bottom-nav{
      position:fixed;left:0;bottom:0;width:100%;background:#fff;border-top:1px solid #ddd;
      display:flex;justify-content:space-around;align-items:center;height:70px;
      box-shadow:0 -2px 8px rgba(0,0,0,0.08);z-index:1000;
    }
    .bottom-nav img{width:50px;height:auto;display:block;}
  </style>
</head>

<body>
  <header>
    <div class="titleRow">
      <img src="syoshinsya.png" alt="初心者" />
      <span>コースデビュー「いろは」</span>
    </div>
    <span class="sub">ラウンドの流れがわかる “超入門”</span>
  </header>

  <div class="topArea">
    <a class="topBtn" href="index.html">トップへ戻る</a>
    <div class="searchWrap">
      <input id="searchInput" type="search" placeholder="基本ルールを検索..." />
    </div>
  </div>

  <div class="chipRow" id="chipRow"></div>

  <section class="results" id="results">
    <div class="resultsHeader" id="resultsHeader">検索結果</div>
    <div class="resultsGrid" id="resultsGrid"></div>
  </section>

  <main class="categoryGrid" id="categoryGrid"></main>

  <nav class="bottom-nav">
    <a href="index.html"><img src="home-icon.png" alt="ホーム" /></a>
    <a href="rules.html"><img src="book-icon.png" alt="ルール一覧" /></a>
    <a href="favorites.html"><img src="star-icon.png" alt="お気に入り" /></a>
  </nav>

  <script>
    const esc = (s) => String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");

    // ★「その他」を作らないため、表示対象カテゴリを固定
    const CATEGORY_ORDER = ["準備","1日の流れ","基礎","用語","マナー","ルール"];

    let ALL_RULES = [];
    let activeCategory = "すべて";

    document.addEventListener("DOMContentLoaded", async () => {
      const grid = document.getElementById("categoryGrid");
      try{
        const res = await fetch("basic_rules.json", { cache:"no-store" });
        ALL_RULES = await res.json();
      }catch(e){
        grid.innerHTML = `<div style="grid-column:1/-1;padding:14px;font-weight:800;">読み込みに失敗しました。</div>`;
        return;
      }

      ALL_RULES = (ALL_RULES||[]).map(r => ({
        id: Number(r.id),
        category: String(r.category || ""),
        order: Number(r.order ?? 9999),
        title: String(r.title || ""),
        description: String(r.description || "")
      }));

      renderChips();
      renderCategoryAccordions();
      bindSearch();
    });

    function getCategories(){
      // ★JSONに変なカテゴリが混ざっても「その他」にまとめない（無視）
      const set = new Set(ALL_RULES.map(r => r.category));
      const cats = CATEGORY_ORDER.filter(c => set.has(c));
      return cats;
    }

    function renderChips(){
      const chipRow = document.getElementById("chipRow");
      const cats = getCategories();
      const all = ["すべて", ...cats];

      chipRow.innerHTML = all.map(c => {
        const cls = (c === activeCategory) ? "chip active" : "chip";
        return `<button class="${cls}" type="button" data-cat="${esc(c)}">${esc(c)}</button>`;
      }).join("");

      chipRow.onclick = (e) => {
        const btn = e.target.closest(".chip");
        if(!btn) return;
        activeCategory = btn.dataset.cat;

        document.querySelectorAll(".chip").forEach(x => x.classList.remove("active"));
        btn.classList.add("active");

        const input = document.getElementById("searchInput");
        if(input) input.value = "";
        hideResults();
        renderCategoryAccordions();
      };
    }

    function renderCategoryAccordions(){
      const grid = document.getElementById("categoryGrid");
      const cats = getCategories();
      const targetCats = (activeCategory === "すべて") ? cats : cats.filter(c => c === activeCategory);

      grid.innerHTML = targetCats.map(cat => {
        const items = ALL_RULES
          .filter(r => r.category === cat)
          .sort((a,b)=> (a.order-b.order) || (a.id-b.id));

        const itemHtml = items.map(r =>
          `<a class="itemBtn" href="basic_rule_detail.html?id=${r.id}">${esc(r.title)}</a>`
        ).join("");

        return `
          <section class="accordion">
            <button class="accHeader" type="button" aria-expanded="false">
              <div class="accTitle">${esc(cat)}</div>
              <div class="accArrow">▼</div>
            </button>
            <div class="accPanel">
              <div class="itemList">${itemHtml}</div>
            </div>
          </section>
        `;
      }).join("");

      // 1つだけ開閉（隣に波及しない）
      grid.onclick = (e) => {
        const header = e.target.closest(".accHeader");
        if(!header) return;
        const acc = header.closest(".accordion");
        const willOpen = !acc.classList.contains("open");
        acc.classList.toggle("open", willOpen);
        header.setAttribute("aria-expanded", String(willOpen));
      };
    }

    function bindSearch(){
      const input = document.getElementById("searchInput");
      input.oninput = () => {
        const q = input.value.trim().toLowerCase();
        if(!q){ hideResults(); return; }

        const pool = (activeCategory === "すべて")
          ? ALL_RULES.filter(r => CATEGORY_ORDER.includes(r.category))
          : ALL_RULES.filter(r => r.category === activeCategory);

        const hits = pool.filter(r => (r.title + " " + r.description).toLowerCase().includes(q)).slice(0, 40);
        showResults(q, hits);
      };
    }

    function showResults(q, hits){
      const wrap = document.getElementById("results");
      const header = document.getElementById("resultsHeader");
      const grid = document.getElementById("resultsGrid");
      wrap.style.display = "block";
      header.textContent = `検索結果：「${q}」`;

      if(hits.length === 0){
        grid.innerHTML = `<div style="padding:12px;color:#666;font-weight:800;">見つかりませんでした。</div>`;
        return;
      }

      grid.innerHTML = hits.map(r => `
        <a class="resultBtn" href="basic_rule_detail.html?id=${r.id}">
          ${esc(r.title)}
          <div class="resultMeta">${esc(r.category)}</div>
        </a>
      `).join("");
    }

    function hideResults(){
      const wrap = document.getElementById("results");
      const grid = document.getElementById("resultsGrid");
      wrap.style.display = "none";
      grid.innerHTML = "";
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>コースデビュー「いろは」 | 3タップルールズ</title>

  <style>
    :root{
      --green:#00bfa5;
      --deep:#0a7f6f;
      --yellow:#FFD84D;
      --bg:#f3fff7;
      --card:#ffffff;
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      --shadow2: 0 3px 10px rgba(0,0,0,0.08);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: "Helvetica","Arial",sans-serif;
      background: var(--bg);
      padding-bottom: 90px;
      color:#222;
      -webkit-text-size-adjust: 100%;
    }

    header{
      background: var(--green);
      color:#fff;
      text-align:center;
      padding: 18px 14px 16px;
      font-size: 24px;
      font-weight: 800;
      border-bottom-left-radius: 28px;
      border-bottom-right-radius: 28px;
      box-shadow: var(--shadow);
      position: sticky;
      top:0;
      z-index: 10;
    }
    header .sub{
      display:block;
      font-size: 14px;
      font-weight: 700;
      opacity: 0.95;
      margin-top: 6px;
    }
    header .badge{
      display:inline-block;
      vertical-align: -3px;
      margin-right: 8px;
      width: 22px;
      height: 22px;
    }

    .topArea{
      width: 92%;
      max-width: 720px;
      margin: 14px auto 10px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .topBtn{
      display:block;
      width:100%;
      border-radius: 999px;
      background: var(--yellow);
      color:#333;
      font-weight: 800;
      text-align:center;
      padding: 14px 0;
      text-decoration:none;
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
      letter-spacing: .02em;
      font-size: 18px;
    }

    .searchWrap{
      background: rgba(255,255,255,0.75);
      border-radius: 999px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      padding: 10px 14px;
    }
    #searchInput{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      font-size: 16px;
      padding: 6px 2px;
      color:#333;
    }

    .chipRow{
      width: 92%;
      max-width: 720px;
      margin: 0 auto 10px;
      display:flex;
      gap: 10px;
      overflow-x:auto;
      padding: 4px 2px 10px;
      -webkit-overflow-scrolling: touch;
    }
    .chipRow::-webkit-scrollbar{ display:none; }
    .chip{
      flex: 0 0 auto;
      border:none;
      cursor:pointer;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 800;
      font-size: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.10);
      background: #fff;
      color: var(--deep);
      white-space: nowrap;
    }
    .chip.active{
      background: rgba(0,191,165,0.14);
      outline: 2px solid rgba(0,191,165,0.22);
    }

    /* 検索結果 */
    .results{
      width: 92%;
      max-width: 720px;
      margin: 0 auto 8px;
      display:none;
      background: rgba(255,255,255,0.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 12px;
    }
    .resultsHeader{
      font-weight: 900;
      color: var(--deep);
      margin: 2px 4px 10px;
      font-size: 14px;
    }
    .resultsGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    /* カテゴリ（2列） */
    .categoryGrid{
      width: 92%;
      max-width: 720px;
      margin: 0 auto 14px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
      align-items: start;
    }

    .accordion{
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow2);
      overflow: hidden;
      position: relative;
      isolation: isolate;
    }

    /* ✅ “ヘッダーだけ”がクリック対象 */
    .accordionHeader{
      padding: 14px 14px;
      font-weight: 900;
      color: var(--deep);
      display:flex;
      justify-content: space-between;
      align-items:center;
      cursor:pointer;
      user-select:none;
      font-size: 18px;
      min-height: 52px;
      background:#fff;
      position: relative;
      z-index: 2;
      touch-action: manipulation;
    }

    .accordionHeader .title{
      display:block;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .accordionHeader .arrow{
      flex: 0 0 auto;
      font-size: 18px;
      opacity: 0.75;
      margin-left: 10px;
      transition: transform .18s ease;
    }
    .accordion.open .accordionHeader .arrow{
      transform: rotate(180deg);
    }

    /* ✅ 中は「横長ボタン1列」 */
    .accordionPanel{
      display:none;
      padding: 12px;
      border-top: 1px solid rgba(0,0,0,0.06);
      background:#fff;
      position: relative;
      z-index: 1;
    }
    .accordion.open .accordionPanel{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    /* ✅ 赤枠みたいな横長 */
    .ruleBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;

      width: 100%;
      border-radius: 16px;
      padding: 14px 12px;
      min-height: 54px;

      background: #f9fefe;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      text-decoration:none;

      color:#222;
      font-size: 15px;
      font-weight: 800;
      line-height: 1.35;

      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .ruleBtn:active{ transform: translateY(1px); }

    .empty{
      width: 92%;
      max-width: 720px;
      margin: 10px auto;
      color:#666;
      text-align:center;
      font-weight: 700;
      background: rgba(255,255,255,0.75);
      padding: 12px;
      border-radius: 14px;
      box-shadow: var(--shadow2);
    }

    .bottom-nav{
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 70px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
      z-index: 1000;
    }
    .bottom-nav img{
      width: 50px;
      height: auto;
      display: block;
    }

    @media (max-width: 390px){
      header{ font-size: 22px; }
      .accordionHeader{ font-size: 17px; }
      .ruleBtn{ font-size: 14px; }
    }
  </style>
</head>

<body>
  <header>
    <img class="badge" src="syoshinsya.png" alt="初心者" />
    コースデビュー「いろは」
    <span class="sub">ラウンドの流れがわかる “超入門”</span>
  </header>

  <div class="topArea">
    <a class="topBtn" href="index.html">トップへ戻る</a>

    <div class="searchWrap">
      <input id="searchInput" type="text" placeholder="基本ルールを検索..." />
    </div>
  </div>

  <div class="chipRow" id="chipRow"></div>

  <section class="results" id="results">
    <div class="resultsHeader" id="resultsHeader">検索結果</div>
    <div class="resultsGrid" id="resultsGrid"></div>
  </section>

  <main class="categoryGrid" id="categoryGrid"></main>

  <div class="empty" id="emptyBox" style="display:none;">基本ルールが読み込めませんでした。</div>

  <nav class="bottom-nav">
    <a href="index.html"><img src="home-icon.png" alt="ホーム" /></a>
    <a href="rules.html"><img src="book-icon.png" alt="ルール一覧" /></a>
    <a href="favorites.html"><img src="star-icon.png" alt="お気に入り" /></a>
  </nav>

  <script>
    const esc = (s) => String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");

    const norm = (s) => String(s ?? "").trim();

    function groupBy(arr, keyFn){
      const map = new Map();
      for(const item of arr){
        const k = keyFn(item);
        if(!map.has(k)) map.set(k, []);
        map.get(k).push(item);
      }
      return map;
    }

    let ALL = [];
    let CATEGORIES = [];
    let ACTIVE_CATEGORY = "すべて";

    const elChipRow = document.getElementById("chipRow");
    const elGrid = document.getElementById("categoryGrid");
    const elResults = document.getElementById("results");
    const elResultsHeader = document.getElementById("resultsHeader");
    const elResultsGrid = document.getElementById("resultsGrid");
    const elEmpty = document.getElementById("emptyBox");
    const elSearch = document.getElementById("searchInput");

    function updateChipActive(){
      elChipRow.querySelectorAll(".chip").forEach(ch => {
        ch.classList.toggle("active", (ch.dataset.cat || "") === ACTIVE_CATEGORY);
      });
    }

    function renderChips(categories){
      elChipRow.innerHTML = "";

      const mk = (label) => {
        const b = document.createElement("button");
        b.className = "chip";
        b.textContent = label;
        b.dataset.cat = label;
        return b;
      };

      elChipRow.appendChild(mk("すべて"));
      for(const c of categories) elChipRow.appendChild(mk(c));

      // ✅ チップはここだけで処理（他に波及しない）
      elChipRow.addEventListener("click", (e) => {
        const btn = e.target.closest(".chip");
        if(!btn) return;
        e.preventDefault();
        e.stopPropagation();
        ACTIVE_CATEGORY = btn.dataset.cat || "すべて";
        updateChipActive();
        renderCategoryAccordions();
      }, { capture:true });

      updateChipActive();
    }

    function closeOtherAccordions(currentBox){
      document.querySelectorAll(".accordion.open").forEach(a => {
        if(a !== currentBox) a.classList.remove("open");
      });
    }

    function attachAccordionBehavior(box){
      const head = box.querySelector(".accordionHeader");

      // ✅ capture:true + stopImmediatePropagation で “他の要素に絶対伝播させない”
      head.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();

        closeOtherAccordions(box);
        box.classList.toggle("open");
      }, { capture:true });

      // ✅ パネル内クリックが変なところに波及しない保険
      const panel = box.querySelector(".accordionPanel");
      panel.addEventListener("click", (e) => {
        e.stopPropagation();
      }, { capture:true });
    }

    function renderCategoryAccordions(){
      const q = norm(elSearch.value);
      const isSearching = q.length > 0;

      if(isSearching){
        elGrid.style.display = "none";
        return;
      } else {
        elGrid.style.display = "grid";
      }

      const filtered = (ACTIVE_CATEGORY === "すべて")
        ? ALL.slice()
        : ALL.filter(r => norm(r.level) === ACTIVE_CATEGORY);

      const map = groupBy(filtered, r => norm(r.level) || "その他");

      const keys = (ACTIVE_CATEGORY === "すべて")
        ? CATEGORIES.filter(k => map.has(k))
        : [ACTIVE_CATEGORY];

      elGrid.innerHTML = "";

      for(const cat of keys){
        const items = (map.get(cat) || []).slice().sort((a,b) => (a.id ?? 0) - (b.id ?? 0));

        const box = document.createElement("div");
        box.className = "accordion";

        const head = document.createElement("div");
        head.className = "accordionHeader";
        head.innerHTML = `<span class="title">${esc(cat)}</span><span class="arrow">▼</span>`;

        const panel = document.createElement("div");
        panel.className = "accordionPanel";

        // ✅ 件数1でも必ずパネルに格納（最初は閉じた状態）
        for(const r of items){
          const a = document.createElement("a");
          a.className = "ruleBtn";
          a.href = `basic_rule_detail.html?id=${encodeURIComponent(r.id)}`;
          a.textContent = norm(r.title) || "(無題)";
          panel.appendChild(a);
        }

        box.appendChild(head);
        box.appendChild(panel);
        elGrid.appendChild(box);

        attachAccordionBehavior(box);
      }
    }

    function renderSearchResults(){
      const q = norm(elSearch.value);
      const isSearching = q.length > 0;

      if(!isSearching){
        elResults.style.display = "none";
        elResultsGrid.innerHTML = "";
        elResultsHeader.textContent = "検索結果";
        renderCategoryAccordions();
        return;
      }

      elGrid.style.display = "none";
      elResults.style.display = "block";

      const qLower = q.toLowerCase();
      const hits = ALL.filter(r => {
        const t = (norm(r.title) + " " + norm(r.description) + " " + norm(r.detail) + " " + norm(r.level)).toLowerCase();
        return t.includes(qLower);
      }).slice(0, 50);

      elResultsHeader.textContent = `検索結果：${hits.length}件`;

      if(hits.length === 0){
        elResultsGrid.innerHTML = `<div class="empty" style="grid-column:1/-1; margin:0;">該当するルールがありません。</div>`;
        return;
      }

      elResultsGrid.innerHTML = "";
      for(const r of hits){
        const a = document.createElement("a");
        a.className = "ruleBtn";
        a.href = `basic_rule_detail.html?id=${encodeURIComponent(r.id)}`;
        a.textContent = norm(r.title) || "(無題)";
        elResultsGrid.appendChild(a);
      }
    }

    async function init(){
      try{
        const res = await fetch("basic_rules.json", { cache: "no-store" });
        ALL = await res.json();
        if(!Array.isArray(ALL)) ALL = [];
      }catch(e){
        console.warn("basic_rules.json 読み込み失敗:", e);
        ALL = [];
      }

      if(ALL.length === 0){
        elEmpty.style.display = "block";
        elChipRow.style.display = "none";
        elResults.style.display = "none";
        elGrid.style.display = "none";
        return;
      }

      const seen = new Set();
      CATEGORIES = [];
      for(const r of ALL){
        const lv = norm(r.level) || "その他";
        if(!seen.has(lv)){
          seen.add(lv);
          CATEGORIES.push(lv);
        }
      }

      renderChips(CATEGORIES);
      renderCategoryAccordions();
      elSearch.addEventListener("input", renderSearchResults);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
